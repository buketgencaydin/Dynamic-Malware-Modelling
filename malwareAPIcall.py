import pefile
import os
import filetype
import pandas as pd

#!pip install filetype

malwareRootPath = "/home/buket/Desktop/malware_api_class-master/src/utility/malwares"
malwareClasses = os.listdir(malwareRootPath)

malwareClasses

counter_exe = 0
counter_non_exe = 0
EXE_FILE_LIST = []
for dirname in malwareClasses:
    fullPath = f'{malwareRootPath}/{dirname}'
    files = os.listdir(fullPath)
    for file in files:
        typ = filetype.guess(f'{fullPath}/{file}')
        if typ is None:
            continue
        if typ.extension == 'exe':
            counter_exe += 1
            EXE_FILE_LIST.append(f'{fullPath}/{file}')
        else:
            counter_non_exe += 1
            
            
print(counter_exe)
print(counter_non_exe)

len(EXE_FILE_LIST)


EXE_FILE_LIST[0]


dataset_dict = {'file':[], 'api':[], 'class':[]}
counter = 0
for exe_file in EXE_FILE_LIST:
    tokens = exe_file.split('/')
    malware_class, filename = tokens[-2:][0], tokens[-2:][1]
    API_CALLS = []
    pe = pefile.PE(exe_file)
    try:
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            for api in entry.imports:
                if api.name: 
                    API_CALLS.append(str(api.name, "utf-8"))
        api_calls = ','.join(API_CALLS)
        dataset_dict['file'].append(filename)
        dataset_dict['class'].append(malware_class)
        dataset_dict['api'].append(api_calls)
    except:
        continue
    if counter % 50 == 0:
        print(f'{counter} has been done!!!!')
    counter += 1


len(dataset_dict['file'])

df = pd.DataFrame(dataset_dict)

df.head()

df['class'].value_counts()

df.to_csv('buket_part.csv', index=False)